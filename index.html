<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario Institucional - ANAM</title>

<!--  ANTI-CACH -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
body{font-family:Arial;background:#f1f1f1;padding:20px}
.container{background:#fff;padding:30px;max-width:700px;margin:auto;border-radius:8px}
label{font-weight:bold}
select,input,textarea{width:100%;padding:10px;margin:8px 0 18px;border-radius:4px;border:1px solid #ccc}
button{background:#6A0F49;color:#fff;padding:12px;border:none;width:100%;border-radius:4px;font-size:16px}
button:disabled{opacity:.5}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center}
.modal-box{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:400px}
</style>
</head>
<body>

<div class="container">
<h2>Formulario Institucional de Retorno</h2>

<p><strong>Folio:</strong> <span id="folio">--</span></p>
<p><strong>Fecha:</strong> <span id="fechaHora"></span></p>

<form id="formRetorno">

<label>Tipo de Operaci贸n</label>
<select id="operacion" required>
<option value="">Seleccione</option>
<option>IMPORTACION</option>
<option>EXPORTACION</option>
</select>

<label>Operador</label>
<input type="text" id="operador" required>

<label>Tipo de Solicitud</label>
<select id="tipo" required>
<option value="">Seleccione</option>
<option>Retorno Para Nueva Exploraci贸n</option>
<option>Retorno Fuera De Horario</option>
<option>Retorno Sin Servicio Extraordinario</option>
<option>Retorno Por Equivocaci贸n de Carril</option>
<option>Solicitud de Revisi贸n De Mercanc铆a Sobre-Dimensionada</option>
</select>

<label>Placas</label>
<textarea id="placas" required></textarea>

<div id="mercanciaDiv" class="hidden">
<label>Mercanc铆a</label>
<textarea id="mercancia"></textarea>
</div>

<button type="submit" id="btnEnviar" disabled>Generar Correo</button>

</form>
</div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
<div class="modal-box">
<h3>Selecciona m茅todo de env铆o</h3>
<button id="btnWeb">Outlook Web</button>
<button id="btnApp" style="margin-top:10px">Aplicaci贸n Outlook</button>
<button id="btnCancelar" style="margin-top:10px;background:#999">Cancelar</button>
</div>
</div>

<script>

const form = document.getElementById("formRetorno");
const btnEnviar = document.getElementById("btnEnviar");
const modal = document.getElementById("modal");

const operacion = document.getElementById("operacion");
const operador = document.getElementById("operador");
const tipo = document.getElementById("tipo");
const placas = document.getElementById("placas");
const mercanciaDiv = document.getElementById("mercanciaDiv");
const mercancia = document.getElementById("mercancia");

let datosCorreo = null;
let bloqueo = false;

/*  LIMPIA POSIBLE REDIRECCIN PREVIA */
window.history.replaceState(null, null, window.location.pathname);

/* FECHA */
function actualizarFecha(){
document.getElementById("fechaHora").textContent = new Date().toLocaleString();
}
actualizarFecha();
setInterval(actualizarFecha,1000);

/* VALIDACIN REAL */
function validar(){
btnEnviar.disabled = !form.checkValidity();
}
form.addEventListener("input",validar);
form.addEventListener("change",validar);

/* MOSTRAR MERCANCA */
tipo.addEventListener("change",()=>{
if(tipo.value==="Solicitud de Revisi贸n De Mercanc铆a Sobre-Dimensionada"){
mercanciaDiv.classList.remove("hidden");
mercancia.required=true;
}else{
mercanciaDiv.classList.add("hidden");
mercancia.required=false;
}
validar();
});

/* FOLIO NICO */
function generarFolio(){
const hoy=new Date();
const base=hoy.getFullYear().toString()+
("0"+(hoy.getMonth()+1)).slice(-2)+
("0"+hoy.getDate()).slice(-2);

let contador=localStorage.getItem("folio_"+base);
contador=contador?parseInt(contador)+1:1;
localStorage.setItem("folio_"+base,contador);

return `RET-${base}-${String(contador).padStart(3,'0')}`;
}

/* SUBMIT */
form.addEventListener("submit",function(e){
e.preventDefault();
if(!form.checkValidity()||bloqueo)return;

bloqueo=true;
btnEnviar.disabled=true;

const folio=generarFolio();
document.getElementById("folio").textContent=folio;

let cuerpo=`FOLIO: ${folio}
Fecha: ${document.getElementById("fechaHora").textContent}
Operaci贸n: ${operacion.value}
Operador: ${operador.value}

Tipo:
${tipo.value}

Placas:
${placas.value}`;

if(!mercanciaDiv.classList.contains("hidden")){
cuerpo+=`\n\nMercanc铆a:\n${mercancia.value}`;
}

datosCorreo={
asunto:`${operacion.value} - ${tipo.value}`,
cuerpo:cuerpo
};

modal.classList.remove("hidden");
});

/* BOTONES MODAL */
document.getElementById("btnWeb").addEventListener("click",()=>{
abrirCorreo("web");
});
document.getElementById("btnApp").addEventListener("click",()=>{
abrirCorreo("app");
});
document.getElementById("btnCancelar").addEventListener("click",resetear);

/* ABRIR CORREO SOLO POR CLICK */
function abrirCorreo(modo){

if(!datosCorreo)return;

const to="jorge.silva@anam.gob.mx";
const subject=encodeURIComponent(datosCorreo.asunto);
const body=encodeURIComponent(datosCorreo.cuerpo);

if(modo==="web"){
window.open(`https://outlook.office.com/mail/deeplink/compose?to=${to}&subject=${subject}&body=${body}`,"_blank");
}else{
window.open(`mailto:${to}?subject=${subject}&body=${body}`,"_blank");
}

resetear();
}

/* RESET */
function resetear(){
modal.classList.add("hidden");
form.reset();
bloqueo=false;
validar();
}

validar();

</script>
</body>
</html>
