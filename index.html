<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANAM - Retornos</title>

<style>
body{
margin:0;
font-family:Arial, Helvetica, sans-serif;
background:#F4F4F4;
color:#161A1D;
}

.top-bar{
background:#611232;
color:#fff;
padding:10px;
text-align:center;
font-size:13px;
font-weight:bold;
}

.container{
position:relative;
background:#ffffff;
max-width:680px;
margin:60px auto 20px;
padding:30px;
border-radius:14px;
box-shadow:0 10px 25px rgba(0,0,0,0.1);
border-top:8px solid #1E5B4F;
transition:.3s;
}

.container.sobredimension{
border-top:8px solid #C58F00;
background:#fff9e6;
}

.hidden{display:none}

label{font-weight:bold;font-size:14px;}

select,input,textarea{
width:100%;
padding:9px;
margin:6px 0 14px;
border-radius:6px;
border:1px solid #ccc;
font-size:14px;
}

#placas{text-transform:uppercase}

button{
background:#1E5B4F;
color:#fff;
padding:11px;
border:none;
width:100%;
border-radius:6px;
font-size:15px;
cursor:pointer;
font-weight:bold;
margin-bottom:10px;
}

button:disabled{
background:#98989A;
cursor:not-allowed;
}

.modal{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.5);
justify-content:center;
align-items:center;
}

.modal-content{
background:#fff;
padding:20px;
border-radius:8px;
max-width:350px;
width:90%;
text-align:center;
border-top:6px solid #611232;
}
</style>
</head>

<body>

<div class="top-bar">
Gobierno de M茅xico | Agencia Nacional de Aduanas de M茅xico
</div>

<div class="container" id="container">

<h3>Solicitud de Retornos</h3>

<p><strong>Folio:</strong> <span id="folio">--</span></p>

<form id="formRetorno">

<label>Operador</label>
<input type="text" id="operador" required>

<label>Tipo de Solicitud</label>
<select id="tipo" required>
<option value="">Seleccione...</option>
<option>Retorno Para Nueva Exploraci贸n</option>
<option>Retorno Fuera De Horario</option>
<option>Retorno Sin Servicio Extraordinario</option>
<option>Retorno Por Equivocaci贸n de Carril</option>
<option>Solicitud de Revisi贸n De Mercanc铆a Sobre-Dimensionada</option>
</select>

<div id="descripcionDiv" class="hidden">
<label>Descripci贸n de la Mercanc铆a</label>
<textarea id="descripcion"></textarea>
</div>

<label>Placas</label>
<textarea id="placas" required></textarea>

<button type="submit" id="btnGenerar" disabled>Generar Correo</button>
<button type="button" id="btnCancelar" disabled>Cancelar</button>

</form>
</div>

<div id="selectorModal" class="modal">
<div class="modal-content">
<h3>驴C贸mo deseas enviar?</h3>
<button onclick="abrirApp()">Abrir App Outlook</button>
<button onclick="abrirWeb()">Abrir Outlook Web</button>
<button onclick="cerrarModal()">Cancelar</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/*  CONFIGURACIN FIREBASE */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  databaseURL: "TU_DATABASE_URL",
  projectId: "TU_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/*  ELEMENTOS */
const form = document.getElementById("formRetorno");
const operador = document.getElementById("operador");
const tipo = document.getElementById("tipo");
const placas = document.getElementById("placas");
const descripcion = document.getElementById("descripcion");
const descripcionDiv = document.getElementById("descripcionDiv");
const btnGenerar = document.getElementById("btnGenerar");
const btnCancelar = document.getElementById("btnCancelar");
const container = document.getElementById("container");
const folioSpan = document.getElementById("folio");

/*  FECHA */
function fechaActual(){
  return new Date().toISOString().split("T")[0].replace(/-/g,"");
}

/*  FOLIO CONSECUTIVO */
async function generarFolio(){
  const fecha = fechaActual();
  const contadorRef = ref(db,"folios/"+fecha);

  const resultado = await runTransaction(contadorRef,(actual)=>{
    return (actual || 0) + 1;
  });

  const numero = resultado.snapshot.val();
  return `RET-${fecha}-${numero.toString().padStart(3,"0")}`;
}

/*  VALIDACIN */
function validar(){

  let completo = operador.value.trim()!=="" &&
                 tipo.value!=="" &&
                 placas.value.trim()!=="";

  if(tipo.value==="Solicitud de Revisi贸n De Mercanc铆a Sobre-Dimensionada"){
    completo = completo && descripcion.value.trim()!=="";
  }

  btnGenerar.disabled=!completo;

  let hayDatos = operador.value.trim()!=="" ||
                 placas.value.trim()!=="" ||
                 descripcion.value.trim()!=="";

  btnCancelar.disabled=!hayDatos;
}

operador.addEventListener("input",validar);
placas.addEventListener("input",()=>{
  placas.value=placas.value.toUpperCase();
  validar();
});
descripcion.addEventListener("input",validar);

tipo.addEventListener("change",()=>{
  if(tipo.value==="Solicitud de Revisi贸n De Mercanc铆a Sobre-Dimensionada"){
    descripcionDiv.classList.remove("hidden");
    descripcion.required=true;
    container.classList.add("sobredimension");
  }else{
    descripcionDiv.classList.add("hidden");
    descripcion.required=false;
    descripcion.value="";
    container.classList.remove("sobredimension");
  }
  validar();
});

/*  GENERAR */
form.addEventListener("submit", async function(e){
  e.preventDefault();

  btnGenerar.disabled=true;

  const folio = await generarFolio();
  folioSpan.textContent = folio;

  let cuerpo = `Folio: ${folio}
Operador: ${operador.value}
Tipo: ${tipo.value}

Placas:
${placas.value}`;

  if(descripcion.value){
    cuerpo+=`\n\nDescripci贸n:\n${descripcion.value}`;
  }

  if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
    window.location.href="mailto:jorge.silva@anam.gob.mx?subject="+encodeURIComponent(tipo.value)+"&body="+encodeURIComponent(cuerpo);
  }else{
    window.asunto=tipo.value;
    window.cuerpo=cuerpo;
    document.getElementById("selectorModal").style.display="flex";
  }

  form.reset();
  descripcionDiv.classList.add("hidden");
  container.classList.remove("sobredimension");
  btnCancelar.disabled=true;
});

/*  CANCELAR */
btnCancelar.onclick=function(){
  form.reset();
  descripcionDiv.classList.add("hidden");
  container.classList.remove("sobredimension");
  btnGenerar.disabled=true;
  btnCancelar.disabled=true;
};

/*  OUTLOOK */
window.abrirApp=function(){
  window.location.href="mailto:jorge.silva@anam.gob.mx?subject="+encodeURIComponent(window.asunto)+"&body="+encodeURIComponent(window.cuerpo);
  cerrarModal();
}

window.abrirWeb=function(){
  window.open("https://outlook.office.com/mail/deeplink/compose?to=jorge.silva@anam.gob.mx&subject="+encodeURIComponent(window.asunto)+"&body="+encodeURIComponent(window.cuerpo),"_blank");
  cerrarModal();
}

window.cerrarModal=function(){
  document.getElementById("selectorModal").style.display="none";
}

</script>

</body>
</html>
