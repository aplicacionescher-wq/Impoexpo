<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANAM - Solicitud de Retornos</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#611232">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
margin:0;
font-family:Arial, Helvetica, sans-serif;
background:#F4F4F4;
color:#161A1D;
}

.top-bar{
background:#611232;
color:#fff;
padding:10px 15px;
font-size:13px;
font-weight:bold;
text-align:center;
}

.container{
position:relative;
background:#ffffffee;
max-width:720px;
margin:70px auto 20px;
padding:40px 25px 30px;
border-radius:14px;
box-shadow:0 10px 25px rgba(0,0,0,0.1);
border-top:8px solid #1E5B4F;
overflow:hidden;
}

.container::before{
content:"";
position:absolute;
inset:0;
background:url("logo-anam.png") center center no-repeat;
background-size:280px;
opacity:0.05;
pointer-events:none;
}

.logo-gota{
position:absolute;
top:-40px;
left:50%;
transform:translateX(-50%);
width:85px;
height:85px;
border-radius:50%;
display:flex;
justify-content:center;
align-items:center;
backdrop-filter:blur(10px);
background:rgba(255,255,255,0.7);
box-shadow:0 8px 18px rgba(0,0,0,0.2);
border:3px solid #A57F2C;
z-index:2;
}

.logo-gota img{width:65px;}

.title{
text-align:center;
color:#611232;
font-size:18px;
font-weight:bold;
margin:15px 0;
}

h3{
color:#611232;
border-bottom:2px solid #A57F2C;
padding-bottom:6px;
font-size:15px;
}

label{font-weight:bold;font-size:14px;}

select,input,textarea{
width:100%;
padding:9px;
margin:6px 0 14px;
border-radius:6px;
border:1px solid #ccc;
font-size:14px;
}

#placas{text-transform:uppercase}

button{
background:#1E5B4F;
color:#fff;
padding:10px;
border:none;
width:100%;
border-radius:6px;
font-size:14px;
cursor:pointer;
font-weight:bold;
margin-top:6px;
}

button:hover{opacity:0.9;}

button:disabled{
background:#999;
cursor:not-allowed;
opacity:0.6;
}

.hidden{display:none}

.modal{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.5);
justify-content:center;
align-items:center;
z-index:1000;
}

.modal-content{
background:#fff;
padding:20px;
border-radius:8px;
width:320px;
text-align:center;
border-top:6px solid #611232;
}

table{
width:100%;
border-collapse:collapse;
margin-top:15px;
}

th,td{
border:1px solid #ccc;
padding:6px;
font-size:12px;
text-align:center;
}

th{
background:#611232;
color:#fff;
}

.footer{
text-align:center;
font-size:11px;
color:#98989A;
margin:20px 0;
}
</style>
</head>

<body>

<div class="top-bar">
Gobierno de México | Agencia Nacional de Aduanas de México
</div>

<div class="container">

<div class="logo-gota">
<img src="logo-anam2.png">
</div>

<div class="title">
Solicitud de Retornos Módulos
</div>

<h3>Generador de Solicitudes</h3>

<p><strong>Folio:</strong> <span id="folio">--</span></p>
<p><strong>Fecha:</strong> <span id="fechaHora"></span></p>

<form id="formRetorno">

<label>Tipo de Operación</label>
<select id="operacion" required>
<option>IMPORTACION</option>
<option selected>EXPORTACION</option>
</select>

<label>Operador</label>
<input type="text" id="operador" required>

<label>Tipo de Solicitud</label>
<select id="tipo" required>
<option value="nueva" selected>Retorno Para Nueva Exploración</option>
<option value="horario">Retorno Fuera De Horario</option>
<option value="sin_extra">Retorno Sin Servicio Extraordinario</option>
<option value="carril">Retorno Por Equivocación de Carril</option>
<option value="revision">Solicitud de Revisión De Mercancía Sobre-Dimensionada</option>
</select>

<label>Placas</label>
<textarea id="placas" required></textarea>

<div id="mercanciaDiv" class="hidden">
<label>Descripción de la Mercancía</label>
<textarea id="mercancia"></textarea>
</div>

<button type="submit" id="btnGenerar" disabled>Generar Correo</button>

<hr>

<label>Seleccionar fecha (opcional)</label>
<input type="date" id="fechaConsulta">

<button type="button" onclick="consultarPlacas()">Consultar Placas</button>
<button type="button" onclick="exportarExcel()">Exportar a Excel</button>

<div id="tablaResultados"></div>

</form>
</div>

<div class="footer">
© 2026 Agencia Nacional de Aduanas de México
</div>

<div id="selectorModal" class="modal">
<div class="modal-content">
<h3>¿Cómo deseas enviar el correo?</h3>
<button onclick="abrirApp()">Abrir App Outlook</button>
<button onclick="abrirWeb()">Abrir Outlook Web</button>
<button onclick="cerrarModal()">Cancelar</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
apiKey: "TU_API_KEY",
authDomain: "retornos-anam-altamira.firebaseapp.com",
databaseURL: "https://retornos-anam-altamira-default-rtdb.firebaseio.com",
projectId: "retornos-anam-altamira",
storageBucket: "retornos-anam-altamira.firebasestorage.app",
messagingSenderId: "975848132753",
appId: "1:975848132753:web:cdb84e00b5d33006ffef30"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const form=document.getElementById("formRetorno");
const tipo=document.getElementById("tipo");
const mercanciaDiv=document.getElementById("mercanciaDiv");
const mercancia=document.getElementById("mercancia");
const placas=document.getElementById("placas");
const operacion=document.getElementById("operacion");
const operador=document.getElementById("operador");
const modal=document.getElementById("selectorModal");
const btnGenerar=document.getElementById("btnGenerar");

let tablaVisible=false;

const destinatarios="jorge.silva@anam.gob.mx;vyc.altamira@anam.gob.mx;alejandra.munoz@anam.gob.mx;nayely.chavez@anam.gob.mx;miguel.herrera@anam.gob.mx;abraham.gomez@anam.gob.mx;daniel.santosh@anam.gob.mx;christian.monrreal@anam.gob.mx;monica.becerra@anam.gob.mx;anahi.santiago@anam.gob.mx";

function validarFormulario(){
btnGenerar.disabled = !form.checkValidity();
}

form.addEventListener("input", validarFormulario);
tipo.addEventListener("change", validarFormulario);
operacion.addEventListener("change", validarFormulario);

placas.addEventListener("input",()=>{
placas.value=placas.value.toUpperCase();
validarFormulario();
});

tipo.addEventListener("change",()=>{
if(tipo.value==="revision"){
mercanciaDiv.classList.remove("hidden");
mercancia.required=true;
}else{
mercanciaDiv.classList.add("hidden");
mercancia.required=false;
mercancia.value="";
}
validarFormulario();
});

function actualizarFecha(){
document.getElementById("fechaHora").textContent=new Date().toLocaleString();
}
setInterval(actualizarFecha,1000);
actualizarFecha();

document.getElementById("fechaConsulta").value = new Date().toISOString().split("T")[0];

async function generarFolio(){
const hoy=new Date();
const base=hoy.getFullYear().toString()+
("0"+(hoy.getMonth()+1)).slice(-2)+
("0"+hoy.getDate()).slice(-2);

const contadorRef=ref(db,'contadorFolios/'+base);
const result=await runTransaction(contadorRef,(c)=>(c||0)+1);
return "RET-"+base+"-"+result.snapshot.val().toString().padStart(3,"0");
}

form.addEventListener("submit",async e=>{
e.preventDefault();

if(!form.checkValidity()){
form.reportValidity();
return;
}

const folio=await generarFolio();
document.getElementById("folio").textContent=folio;

const hora = new Date().getHours();
let saludo = "";

if (hora < 12) {
saludo = "Buenos días";
} else if (hora < 19) {
saludo = "Buenas tardes";
} else {
saludo = "Buenas noches";
}

let cuerpo = saludo + ",\n\n";

if (tipo.value === "revision") {

cuerpo += 
"Solicito su valioso apoyo para la apertura del carril de excesos de exportación, para el ingreso de excesos de dimensiones y la revisión con sensor canino.\n\n" +
"PLACAS:\n" + placas.value + "\n\n" +
"MERCANCÍA:\n" + mercancia.value + "\n\n" +
"Favor de dar parte al personal del módulo cuando la unidad sea revisada y contestar correo electrónico una vez efectuada la revisión canina.\n\n" +
"Gracias.\n\n" +
"Saludos cordiales,\n" +
operador.value + "\n" +
"Módulos\n" +
"ANAM Altamira";

} else {

if (operacion.value === "EXPORTACION") {

cuerpo +=
"El presente correo es para solicitar la apertura del carril de excesos a la exportación para el retorno al vehículo con las placas siguientes:\n\n" +
"PLACAS:\n" + placas.value + "\n\n" +
"Tipo de retorno:\n" +
tipo.options[tipo.selectedIndex].text + "\n\n" +
"Gracias.\n\n" +
"Saludos cordiales,\n" +
operador.value + "\n" +
"Módulos \n" +
"ANAM Altamira";

} else {

cuerpo +=
"El presente correo es para solicitar la apertura de la Puerta Caracol para el retorno al vehículo con las placas siguientes:\n\n" +
placas.value + "\n\n" +
"Tipo de retorno:\n" +
tipo.options[tipo.selectedIndex].text + "\n\n" +
"Gracias.\n\n" +
"Saludos cordiales,\n" +
operador.value + "\n" +
"Módulos\n" +
"ANAM Altamira";
}
}

await push(ref(db,"retornos"),{
folio,
fecha:new Date().toISOString(),
operacion:operacion.value,
operador:operador.value,
tipo:tipo.value,
placas:placas.value,
mercancia:mercancia.value || ""
});

window.asunto = operacion.value + " - " + tipo.options[tipo.selectedIndex].text;
window.cuerpo=cuerpo;

const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

if(esMovil){

window.location.href =
"ms-outlook://compose?" +
"to=" + encodeURIComponent(destinatarios) +
"&subject=" + encodeURIComponent(window.asunto) +
"&body=" + encodeURIComponent(window.cuerpo);

setTimeout(()=>{
window.location.href =
"mailto:" + destinatarios +
"?subject=" + encodeURIComponent(window.asunto) +
"&body=" + encodeURIComponent(window.cuerpo);
},1500);

}else{
modal.style.display="flex";
}

form.reset();
mercanciaDiv.classList.add("hidden");
mercancia.required=false;
mercancia.value="";
btnGenerar.disabled=true;
document.getElementById("folio").textContent="--";

});

window.abrirApp=function(){
window.location.href="mailto:"+destinatarios+
"?subject="+encodeURIComponent(window.asunto)+
"&body="+encodeURIComponent(window.cuerpo);
cerrarModal();
}

window.abrirWeb=function(){
window.open(
"https://outlook.office.com/mail/deeplink/compose?to="+encodeURIComponent(destinatarios)+
"&subject="+encodeURIComponent(window.asunto)+
"&body="+encodeURIComponent(window.cuerpo),
"_blank"
);
cerrarModal();
}

window.cerrarModal=function(){
modal.style.display="none";
}

window.consultarPlacas = async function(){

const contenedor = document.getElementById("tablaResultados");
const fechaInput = document.getElementById("fechaConsulta").value;

if(tablaVisible){
contenedor.innerHTML="";
tablaVisible=false;
return;
}

const snapshot = await get(ref(db,"retornos"));

let fechaFiltro;

if(fechaInput){
fechaFiltro = fechaInput;
}else{
fechaFiltro = new Date().toISOString().split("T")[0];
}

let html="<table><tr><th>Operador</th><th>Placas</th></tr>";

snapshot.forEach(doc=>{
let d=doc.val();
if(d.fecha.startsWith(fechaFiltro)){
html+="<tr><td>"+d.operador+"</td><td>"+d.placas+"</td></tr>";
}
});

html+="</table>";

contenedor.innerHTML=html;
tablaVisible=true;
}

window.exportarExcel=async function(){
const snapshot=await get(ref(db,"retornos"));
let datos=[];
snapshot.forEach(doc=>datos.push(doc.val()));
const ws=XLSX.utils.json_to_sheet(datos);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Retornos");
XLSX.writeFile(wb,"Retornos_ANAM.xlsx");
}

</script>

</body>
</html>
