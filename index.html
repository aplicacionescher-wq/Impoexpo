<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario Institucional - ANAM</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6A0F49">

<style>
body{font-family:Arial;background:#f1f1f1;padding:20px}

.container{
background:#fff;
padding:30px;
max-width:700px;
margin:auto;
border-radius:8px;
border-top:8px solid #6A0F49;
transition:.3s ease;
}

h2{
color:#6A0F49;
transition:.3s ease;
}

label{font-weight:bold}

select,input,textarea{
width:100%;
padding:10px;
margin:8px 0 18px;
border-radius:4px;
border:1px solid #ccc
}

#placas{
text-transform:uppercase;
}

button{
background:#6A0F49;
color:#fff;
padding:12px;
border:none;
width:100%;
border-radius:4px;
font-size:16px;
cursor:pointer;
transition:.3s ease;
}

button:disabled{opacity:.5}

.importacion{
border-top-color:#6A0F49;
}

.exportacion{
border-top-color:#004578;
}

.exportacion h2{
color:#004578;
}

.exportacion button{
background:#004578;
}

.install-btn{
background:#004578;
margin-bottom:15px;
}

.hidden{display:none}

</style>
</head>
<body>

<div class="container">

<button id="btnInstalar" class="install-btn hidden">Instalar Aplicación</button>

<h2>Módulos Retornos</h2>

<p><strong>Folio:</strong> <span id="folio">--</span></p>
<p><strong>Fecha:</strong> <span id="fechaHora"></span></p>

<form id="formRetorno">

<label>Tipo de Operación</label>
<select id="operacion" required>
<option value="">Seleccione</option>
<option>IMPORTACION</option>
<option>EXPORTACION</option>
</select>

<label>Operador</label>
<input type="text" id="operador" required>

<label>Tipo de Solicitud</label>
<select id="tipo" required>
<option value="">Seleccione</option>
<option>Retorno Para Nueva Exploración</option>
<option>Retorno Fuera De Horario</option>
<option>Retorno Sin Servicio Extraordinario</option>
<option>Retorno Por Equivocación de Carril</option>
<option>Solicitud de Revisión De Mercancía Sobre-Dimensionada</option>
</select>

<label>Placas</label>
<textarea id="placas" required></textarea>

<div id="mercanciaDiv" class="hidden">
<label>Mercancía</label>
<textarea id="mercancia"></textarea>
</div>

<button type="submit" id="btnEnviar" disabled>Generar Correo</button>

</form>
</div>

<script>

/* SERVICE WORKER */
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('sw.js');
}

/* BOTÓN INSTALAR */
let deferredPrompt;
const btnInstalar = document.getElementById("btnInstalar");

window.addEventListener('beforeinstallprompt', (e) => {
e.preventDefault();
deferredPrompt = e;
btnInstalar.classList.remove("hidden");
});

btnInstalar.addEventListener('click', async () => {
deferredPrompt.prompt();
await deferredPrompt.userChoice;
btnInstalar.classList.add("hidden");
});

/* VARIABLES */
const form = document.getElementById("formRetorno");
const btnEnviar = document.getElementById("btnEnviar");
const operacion = document.getElementById("operacion");
const tipo = document.getElementById("tipo");
const placas = document.getElementById("placas");
const mercanciaDiv = document.getElementById("mercanciaDiv");
const mercancia = document.getElementById("mercancia");
const container = document.querySelector(".container");

/* FECHA */
function actualizarFecha(){
document.getElementById("fechaHora").textContent=new Date().toLocaleString();
}
actualizarFecha();
setInterval(actualizarFecha,1000);

/* VALIDACIÓN */
function validar(){
btnEnviar.disabled=!form.checkValidity();
}
form.addEventListener("input",validar);
form.addEventListener("change",validar);

/* MAYÚSCULAS EN PLACAS */
placas.addEventListener("input", function(){
this.value = this.value.toUpperCase();
});

/* CAMBIO DE COLOR */
operacion.addEventListener("change", function(){
container.classList.remove("importacion","exportacion");

if(this.value==="IMPORTACION"){
container.classList.add("importacion");
}

if(this.value==="EXPORTACION"){
container.classList.add("exportacion");
}
});

/* MOSTRAR MERCANCÍA */
tipo.addEventListener("change",()=>{
if(tipo.value==="Solicitud de Revisión De Mercancía Sobre-Dimensionada"){
mercanciaDiv.classList.remove("hidden");
mercancia.required=true;
}else{
mercanciaDiv.classList.add("hidden");
mercancia.required=false;
}
validar();
});

/* FOLIO */
function generarFolio(){
const hoy=new Date();
const base=hoy.getFullYear().toString()+
("0"+(hoy.getMonth()+1)).slice(-2)+
("0"+hoy.getDate()).slice(-2);
let contador=localStorage.getItem("folio_"+base);
contador=contador?parseInt(contador)+1:1;
localStorage.setItem("folio_"+base,contador);
return `RET-${base}-${String(contador).padStart(3,'0')}`;
}

/* ENVÍO OUTLOOK WEB */
form.addEventListener("submit",function(e){
e.preventDefault();
if(!form.checkValidity()) return;

const folio=generarFolio();
document.getElementById("folio").textContent=folio;

let cuerpo=`FOLIO: ${folio}
Fecha: ${document.getElementById("fechaHora").textContent}
Operación: ${operacion.value}
Operador: ${operador.value}

Tipo:
${tipo.value}

Placas:
${placas.value}`;

if(!mercanciaDiv.classList.contains("hidden")){
cuerpo+=`\n\nMercancía:\n${mercancia.value}`;
}

/* DESTINATARIO */
/*const to="jorge.silva@anam.gob.mx";*/

/* COPIAS */
const to= destinatarios = "jorge.silva@anam.gob.mx;vyc.altamira@anam.gob.mx;alejandra.munoz@anam.gob.mx;nayely.chavez@anam.gob.mx;miguel.herrera@anam.gob.mx;abraham.gomez@anam.gob.mx;daniel.santosh@anam.gob.mx;christian.monrreal@anam.gob.mx;monica.becerra@anam.gob.mx;anahi.santiago@anam.gob.mx";

const subject=encodeURIComponent(`${operacion.value} - ${tipo.value}`);
const body=encodeURIComponent(cuerpo);

window.open(`https://outlook.office.com/mail/deeplink/compose?to=${to}&cc=${cc}&subject=${subject}&body=${body}`,"_blank");

form.reset();
validar();

});

validar();

</script>
</body>
</html>
