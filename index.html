<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Solicitudes - ANAM</title>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

<style>
body{
font-family:Arial;
background:#f1f1f1;
margin:0;
padding:20px;
}

.container{
background:white;
max-width:800px;
margin:auto;
padding:20px;
border-radius:10px;
box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

h2{
text-align:center;
color:#6A0F49;
}

label{
font-weight:bold;
}

input, select, textarea{
width:100%;
padding:8px;
margin-bottom:10px;
border-radius:6px;
border:1px solid #ccc;
}

button{
padding:10px;
border:none;
border-radius:6px;
cursor:pointer;
margin:5px 0;
}

.btn-principal{
background:#6A0F49;
color:white;
width:100%;
}

.btn-secundario{
background:#444;
color:white;
width:100%;
}

#placasHoy{
display:none;
margin-top:15px;
background:#f9f9f9;
padding:10px;
border-radius:6px;
}
</style>
</head>
<body>

<div class="container">

<h2>Generador de Solicitudes</h2>

<form id="formulario">

<label>Fecha</label>
<input type="text" id="fecha" readonly>

<label>Folio</label>
<input type="text" id="folio" readonly>

<label>Tipo de Operación</label>
<select id="tipoOperacion">
<option value="Exportación" selected>Exportación</option>
<option value="Importación">Importación</option>
</select>

<label>Tipo de Solicitud</label>
<select id="tipoSolicitud" onchange="validarDescripcion()">
<option value="Retorno Nueva Exploración" selected>Retorno Nueva Exploración</option>
<option value="Solicitud de Revisión">Solicitud de Revisión</option>
<option value="Cambio de Régimen">Cambio de Régimen</option>
<option value="Otro">Otro</option>
</select>

<label>Placas</label>
<input type="text" id="placas" style="text-transform:uppercase">

<label>Descripción de la Mercancía</label>
<textarea id="descripcion" disabled></textarea>

<label>Asunto</label>
<input type="text" id="asunto">

<label>Cuerpo</label>
<textarea id="cuerpo"></textarea>

<input type="hidden" id="destinatarios" value="correo1@anam.gob.mx;correo2@anam.gob.mx">
<input type="hidden" id="cc" value="correo3@anam.gob.mx;correo4@anam.gob.mx">

<button type="button" class="btn-principal" onclick="generarCorreo()">Generar Correo</button>

<button type="button" class="btn-secundario" onclick="consultarPlacas()">Consultar Placas Hoy</button>

<button type="button" class="btn-secundario" onclick="exportarExcel()">Exportar Excel</button>

</form>

<div id="placasHoy"></div>

</div>

<!-- MODAL -->
<div id="modalOutlook" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;justify-content:center;align-items:center;">
<div style="background:white;padding:30px;border-radius:12px;width:320px;text-align:center;">
<h3>Selecciona cómo enviar</h3>
<button onclick="abrirOutlookApp()" style="width:100%;padding:10px;margin:5px;background:#0078D4;color:white;">Abrir Outlook App</button>
<button onclick="abrirOutlookWeb()" style="width:100%;padding:10px;margin:5px;background:#2E8B57;color:white;">Abrir Outlook Web</button>
<button onclick="cerrarModal()" style="width:100%;padding:10px;margin:5px;background:#ccc;">Cancelar</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB_41ENDRUYFLMMsQCXE2Ua8XZjSK5IiOI",
  authDomain: "retornos-anam-altamira.firebaseapp.com",
  databaseURL: "https://retornos-anam-altamira-default-rtdb.firebaseio.com",
  projectId: "retornos-anam-altamira",
  storageBucket: "retornos-anam-altamira.firebasestorage.app",
  messagingSenderId: "975848132753",
  appId: "1:975848132753:web:cdb84e00b5d33006ffef30"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.onload = function(){
generarFecha();
generarNuevoFolio();
}

function generarFecha(){
const hoy = new Date();
document.getElementById("fecha").value = hoy.toLocaleDateString();
}

async function generarNuevoFolio(){
const hoy = new Date();
const clave = hoy.toISOString().split('T')[0];

const refFolio = ref(db, "folios/"+clave);
const snapshot = await get(refFolio);

let consecutivo = 1;

if(snapshot.exists()){
consecutivo = snapshot.val() + 1;
}

await set(refFolio, consecutivo);

document.getElementById("folio").value = clave.replaceAll("-","") + "-" + consecutivo;
}

window.validarDescripcion = function(){
const tipo = document.getElementById("tipoSolicitud").value;
const desc = document.getElementById("descripcion");

if(tipo === "Solicitud de Revisión"){
desc.disabled = false;
}else{
desc.disabled = true;
desc.value = "";
}
}

window.generarCorreo = function(){

const placas = document.getElementById("placas").value.trim();
if(placas === ""){
alert("Debe capturar las placas");
return;
}

const asunto = encodeURIComponent(document.getElementById("asunto").value);
const cuerpo = encodeURIComponent(document.getElementById("cuerpo").value);
const destinatarios = document.getElementById("destinatarios").value;
const cc = document.getElementById("cc").value;

const mailtoLink = `mailto:${destinatarios}?cc=${cc}&subject=${asunto}&body=${cuerpo}`;

const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

window.mailtoTemporal = mailtoLink;

if(esMovil){
window.location.href = mailtoLink;
registrarEnvio();
}else{
document.getElementById("modalOutlook").style.display="flex";
}

}

window.abrirOutlookApp = function(){
window.location.href = window.mailtoTemporal;
cerrarModal();
registrarEnvio();
}

window.abrirOutlookWeb = function(){
const link = window.mailtoTemporal
.replace("mailto:", "https://outlook.office.com/mail/deeplink/compose?")
.replace("?cc=", "&cc=")
.replace("&subject=", "&subject=")
.replace("&body=", "&body=")
.replace("?", "");

window.open(link, "_blank");
cerrarModal();
registrarEnvio();
}

window.cerrarModal = function(){
document.getElementById("modalOutlook").style.display="none";
}

async function registrarEnvio(){

const hoy = new Date().toISOString().split('T')[0];

await push(ref(db, "registros/"+hoy), {
folio: document.getElementById("folio").value,
placas: document.getElementById("placas").value,
fecha: document.getElementById("fecha").value
});

document.getElementById("formulario").reset();
generarFecha();
generarNuevoFolio();
}

window.consultarPlacas = async function(){

const contenedor = document.getElementById("placasHoy");

if(contenedor.style.display === "block"){
contenedor.style.display="none";
return;
}

const hoy = new Date().toISOString().split('T')[0];
const snapshot = await get(ref(db, "registros/"+hoy));

let html = "<h4>Placas enviadas hoy:</h4>";

if(snapshot.exists()){
snapshot.forEach(child=>{
html += child.val().placas + "<br>";
});
}else{
html += "No hay registros hoy";
}

contenedor.innerHTML = html;
contenedor.style.display="block";
}

window.exportarExcel = async function(){

const hoy = new Date().toISOString().split('T')[0];
const snapshot = await get(ref(db, "registros/"+hoy));

let csv = "Folio,Placas,Fecha\n";

if(snapshot.exists()){
snapshot.forEach(child=>{
const data = child.val();
csv += `${data.folio},${data.placas},${data.fecha}\n`;
});
}

const blob = new Blob([csv], { type: "text/csv" });
const url = window.URL.createObjectURL(blob);

const a = document.createElement("a");
a.href = url;
a.download = "retornos_"+hoy+".csv";
a.click();
}

</script>

</body>
</html>
